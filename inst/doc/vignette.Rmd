---
title: "Introducing the 'polmineR'-package"
author: "Andreas Blätte (andreas.blaette@uni-due.de)"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Introduction to polmineR}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}

---

## Purpose

The purpose of the package *polmineR* is to facilitate the interactive analysis of corpora using R. Apart from performance and usability, key considerations for developing the package are:

* To provide a library with standard tasks such as concordances/keyword-in-context, cooccurrence statistics, or feature extraction.

* To keep the original text accessible and to offer a seamless integration of qualitative and quantitative steps in corpus analysis that facilitates validation.

* To create a package that makes the creation and analysis of subcorpora ('partitions') easy. A particular strength of the package is to support research on synchronic and diachronic change of language use.

* To offer performance for users with a standard infrastructure. The package picks up the idea of a three-tier software design. Corpus data are managed and indexed using the [Corpus Workbench (CWB)](http://cwb.sourceforge.net/).

* To support sharing consolidated and documented data, following the ideas of reproducible research.

The 'polmineR' package supplements R packages that are already widely used for text mining. The CRAN task view is a good place to learn about relevant packages, see  [CRAN](https://CRAN.R-project.org/view=NaturalLanguageProcessing). The polmineR is intended to be an interface between the [Corpus Workbench (CWB)](http://cwb.sourceforge.net/), an efficient system for storing and querying large corpora, and existing packages for mining text with advanced statistical methods.

Apart from the speed of text processing, the Corpus Query Processor (CQP) and the [CQP syntax](http://cwb.sourceforge.net/files/CQP_Tutorial.pdf) provide a powerful and widely used syntax to query corpora. This is not an unique idea. Using a combination of R and the CWB implies a software architecture you will also find in the [TXM project](http://sourceforge.net/projects/txm/), or with [CQPweb](http://cwb.sourceforge.net/cqpweb.php). The 'polmineR' package offers a library with the grammer of corpus analysis below a graphical user interface (GUI). It is a toolset to perform simple tasts efficiently as well as to implement complex workflows.

Advanced user will benefit from acquiring a good understanding of the Corpus Workbench. The [Corpus Encoding Tutorial](http://cwb.sourceforge.net/files/CWB_Encoding_Tutorial.pdf) is an authoritative text for that. [The vignette of the rcqp package](https://cran.r-project.org/package=rcqp) includes an excellent explanation of the CWB data-model.

The most important thing users need to now is the difference between "s"- and "p"-attributes. The CWB distinguishes structural attributes (s-attributes) that will contain the metainformation that can be used to generate subcorpora, and positional attributes (p-attributes).  Typically, the p-attributes will be 'word', 'pos' (for part-of-speech) and 'lemma' (for the lemmatized word form). 


## Getting started

##### Check that the CORPUS_REGISTRY environment variable is set

The annex of the vignette includes a detailed explanation how to install polmineR on Windows, MacOS, and Linux. Once you have installed polmineR, check that the environment variable CORPUS_REGISTRY is set. 

```{r, eval = FALSE}
Sys.getenv("CORPUS_REGISTRY")
```

The CORPUS_REGISTRY environment variable defines the directory with registry files that describe where the CWB will find the files of an indexed corpus, and the s- and p-attributes. See the annex for an explanation how to set the CORPUS_REGISTRY environment variable for the current R session, or permanently.


##### Loading polmineR

If the CORPUS_REGISTRY variable is set correctly, i.e. pointing to the directory with the registry files describing the corpora, load the polmineR package.

```{r, message = FALSE}
library(polmineR)
```


##### Using and installing packaged corpora

If you want to use a CWB corpus packaged in a R data package, you can call ´use´ with the name of the R package. To access the corpus in the data package, the CORPUS_REGISTRY environment variable will be reset. In the followings examples, the REUTERS corpus will be used for demonstration purposes. It is a sampe of Reuters articles that is included in the tm package (cp. https://www.scss.tcd.ie/~luzs/t/cs4ll4/sw/reuters21578-xml/) and may already be known for many R users.

```{r, message = FALSE}
use("polmineR")
```


Note that the `use`-function will call the resetRegistry-function that can also be used to set again the original path to the directory with registry files. If you want to use corpora, you can download the EuroParl and the GermaParl data packages from a CRAN-like repository hosted by the PolMine Project.

```{r, eval = FALSE}
install.packages("europarl.en", repo = "http://polmine.sowi.uni-due.de/packages")
install.packages("GermaParl", repo = "http://polmine.sowi.uni-due.de/packages")
```

Data packages with corpora have a version number which may be important for reproducing results, they can include a vignette documenting the data, and functions to perform specialized tasks.


##### Checking that corpora are available

Use the corpus-method to check which corpora are accessible. It should be the REUTERS corpus in our case (the names of CWB corpora are always written upper case). In addition to the English REUTERS corpus, a small subset of the GermaParl corpus ("GERMAPARLMINI") is included in the polmineR package.

```{r, eval = TRUE, message = FALSE}
corpus()
```


##### Session settings

Many functions in the polmineR package use settings that are stored in the general options settings. You can see these settings as follows:

```{r, eval = FALSE, message = FALSE, results = 'hide'}
options()[grep("polmineR", names(options()))]
```

Several methods (such as kwic, or cooccurrences) will use these settings, if no explicit other value is provided. Here are a few examples how to change settings.

```{r}  
options("polmineR.left" = 15)
options("polmineR.right" = 15)
options("polmineR.mc" = FALSE)
```


## Working with corpora: Core methods

Core analytical tasks are implemented as methods (S4 class system), i.e. the bevaviour of the methods changes depending on the object that is supplied. Almost all methods can be applied to corpora as well as partitions (subcorpora). As an easy entry, methods applied to corpora are explained first.


##### Keyword-in-context (kwic)

The kwic method applied to the name of a corpus will return a KWIC object. Output will be shown in the viewer pane of RStudio. You can include metadata from the corpus using the 'meta' parameter.

```{r, eval = TRUE}
kwic("REUTERS", "oil")
kwic("REUTERS", "oil", meta = "places")
kwic("REUTERS", "oil", meta = c("id", "places"))
```

You can also use the CQP query syntax for formulating queries. That way, you can find multi-word expressions, or match in a manner you may know from using regular expressions.

```{r, eval = TRUE}
kwic("REUTERS", '"OPEC.*"')
kwic("REUTERS", '"oil" "price.*"')
```

Explaining the CQP syntax goes beyon this vignette. Consult the [CQP tutorial](http://cwb.sourceforge.net/files/CQP_Tutorial.pdf) to learn more about the CQP syntax.


##### Getting counts and frequencies

You can count one or several hits in a corpus.

```{r, eval = TRUE}
count("REUTERS", "Kuwait")
count("REUTERS", c("Kuwait", "USA", "Bahrain"))
count("REUTERS", c('"United" "States"', '"Saudi" "Arabia.*"'), cqp = TRUE)
```

##### Dispersions

... get dispersions of counts accross one (or two) dimensions ...

```{r, eval = TRUE, message = FALSE}
oil <- dispersion("REUTERS", query = "oil", sAttribute = "id", progress = FALSE)
saudi_arabia <- dispersion(
  "REUTERS", query = '"Saudi" "Arabia.*"',
  sAttribute = "id", cqp = TRUE, progress = FALSE
  )
```

Note that it is a data.table that is returned. Visualising the result as a barplot ...

```{r, eval = TRUE}
barplot(height = saudi_arabia[["count"]], names.arg = saudi_arabia[["id"]], las = 2)
```


##### Cooccurrences

... get cooccurrence statistics ...

```{r, eval = TRUE, message = FALSE}
oil <- cooccurrences("REUTERS", query = "oil")
sa <- cooccurrences("REUTERS", query = '"Saudi" "Arabia.*"', left = 10, right = 10)
top5 <- subset(oil, rank_ll <= 5)
as.data.frame(top5)
```


## Working with subcorpora - partitions

Easily creating partitions (i.e. subcorpora) based on s-attributes is an important feature of the 'polmineR' package. So if we want to work with the articles in the REUTERS corpus related to Kuaweit in 2006:

```{r, eval = TRUE, message = FALSE, results = 'hide'}
kuwait <- partition("REUTERS", places = "kuwait", regex = TRUE)
```

To get some basic information about the partition that has been set up, the 'show'-method can be used. It is also called when you simply type the name of the partition object.

```{r, eval = TRUE}
kuwait
```

To evaluate s-attributes, regular expressions can be used.

```{r, eval = TRUE, message = FALSE}
saudi_arabia <- partition("REUTERS", places = "saudi-arabia", regex = TRUE)
sAttributes(saudi_arabia, "id")
```

If you work with a flat XML structure, the order of the provided s-attributes may be relevant for speeding up the set up of the partition. For a nested XML, it is important that with the order, you move from ancestors to childs. For further information, see the documentation of the partition-function.


## Cooccurrences

The cooccurrences-method can be applied to partition-objects.

```{r, eval = TRUE, message = FALSE}
saudi_arabia <- partition("REUTERS", places = "saudi-arabia", regex = TRUE)
oil <- cooccurrences(saudi_arabia, "oil", pAttribute = "word", left = 10, right = 10)
```

Note that is is possible to provide a query that uses the full CQP syntax. The statistical analysis of collocations to the query can be accessed as the slot "stat" of the context object. Alternatively, you can get the table with the statistics using ´as.data.frame´.

```{r, eval = TRUE}
df <- as.data.frame(oil)
df[1:5, c("word", "ll", "rank_ll")]
```


## Distribution of queries

To understand the occurance of a phenomenon, the distribution of query results across one or two dimensions will often be interesing. This is done via the 'distribution' function. The query may use the CQP syntax.

```{r, eval = TRUE}
q1 <- dispersion(saudi_arabia, query = 'oil', "id", progress = FALSE)
q2 <- dispersion(saudi_arabia, query = c("oil", "barrel"), "id", progress = FALSE)
```


## Getting features

To identify the specific vocabulary of a corpus of interest, a statistical test based (chi square, or log likelihood) can be performed.

```{r, eval = TRUE, message = FALSE}
qatar <- partition("REUTERS", places = "saudi-arabia", regex = TRUE)
qatar <- enrich(qatar, pAttribute = "word")

qatar_features <- features(qatar, "REUTERS", included = TRUE)
y <- subset(qatar_features, rank_chisquare <= 10.83 & count_coi >= 5)
as.data.frame(y)[,c("word", "count_coi", "count_ref", "chisquare")]
```


## Getting a tm TermDocumentMatrix

For many applications, term-document matrices are the point of departure. The tm class TermDocumentMatrix serves as an input to several R packages implementing advanced text mining techniques. Obtaining this input from a corpus imported to the CWB will usually involve setting up a partitionBundle and then applying a method to get the matrix.

```{r, eval = TRUE}
articles <- partitionBundle("REUTERS", sAttribute = "id", progress = FALSE)
articles <- enrich(articles, pAttribute = "word", verbose = FALSE)
tdm <- as.TermDocumentMatrix(articles, col = "count", verbose = FALSE)
class(tdm) # to see what it is
show(tdm)
m <- as.matrix(tdm) # turn it into an ordinary matrix
m[c("oil", "barrel"),]
```


## Moving on

The package includes many features that go beyond this vignette. It is a key aim in the project to develop respective documentation in the vignette and the man pages for the individual functions further. Feedback is very welcome!


## Annex I: Installing polmineR

### Windows 

The following instructions assume that you have installed R. If not, install it from[CRAN](https://cran.r-project.org/bin/windows/base/). An installation of [RStudio](https://www.rstudio.com/products/rstudio/download/#download) is highly recommended.


#### Windows (32 and 64 bit)

For 64bit Windows, an interface included in the package RcppCWB is offered. It can be installed from the R package repository on the Webserver of the PolMine project as follows. It will be installed automatically when you install polmineR. If that does not happen, you can do it manually.

```{r, eval = FALSE}
install.packages("RcppCWB")
```

Then install polmineR.

```{r, eval = FALSE}
install.packages("polmineR")
```

To install the most recent development version that is hosted in a GitHub repository, use the convenient installation mechanism offered by the devtools package.

```{r, eval = FALSE}
install.packages("devtools")
devtools::install_github("PolMine/polmineR", ref = "dev")
```

Finally, as a basic test whether the REUTERS corpus included in the polmineR package (for testing and demonstration purposes) is available, run:

```{r, eval = FALSE}
use("polmineR")
corpus()
```


### macOS

The following instructions for Mac users assume that R is installed on your system. Binaries are available from the [Homepage of the R Project](https://cran.r-project.org/bin/macosx/). An installation of RStudio is highly recommended. Get the Open Source License version of [RStudio Desktop](https://www.rstudio.com/products/rstudio/download/).


##### Installing RcppCWB

To install polmineR on macOS, you first need to install RcppCWB.

First, you will need an installation of Xcode, which you can get it via the Mac App Store. You will also need the Command Line Tools for Xcode. It can be installed from a terminal with:

```{sh, eval = FALSE}
xcode-select --install
```

Please make sure that you agree to the license.

Second, an installation of XQuartz is required, it can be obtained from [www.xquartz.org](https://www.xquartz.org/).

Third, to compile the C code in the RcppCWB package, there are system requirements that need to be fulfilled. Using a package manager makes things considerably easier. We recommend using 'Homebrew'. To install Homebrew, follow the instructions on the [Homebrew Homepage](https://brew.sh/index_de.html). The following commands then need to be executed from a terminal window. They will install the dependencies that the RcppCWB package relies on:

```{sh, eval = FALSE}
brew -v install pkg-config
brew -v install glib --universal
brew -v install pcre --universal
brew -v install readline
```

Fourth, install RcppCWB.

```{r, eval = FALSE}
install.packages("RcppCWB")
```

A quick check that polmineR is installed correctly is to load the library, and to check which corpora are available.

```{r, eval = FALSE}
library(polmineR)
corpus()
```

You should see a message that "CQI.Rcpp" is the interface used, and that the REUTERS corpus is on your system.


#### Installing 'polmineR'

The latest release of polmineR can be installed from CRAN using the usual `install.packages`-function.

```{r mac_install_polmineR_cran, eval = FALSE}
install.packages("polmineR")
```

The development version of *polmineR* can be installed using devtools:

```{r, eval = FALSE}
install.packages("devtools") # unless devtools is already installed
devtools::install_github("PolMine/polmineR", ref = "dev")
```


### Linux (Ubuntu)

#### Installing R

If you have not yet installed R on your Ubuntu machine, there is a good instruction at [ubuntuuser](https://wiki.ubuntuusers.de/R/). To install base R, enter in the terminal.

```{sh, eval = FALSE}
sudo apt-get install r-base r-recommended
```

Make sure that you have installed the latest version of R. The following commands will add the R repository to the package sources and run an update. The second line assumes that you are using Ubuntu 16.04.

```{sh, eval = FALSE}
sudo apt-key adv --recv-keys --keyserver keyserver.ubuntu.com E084DAB9
sudo add-apt-repository 'deb http://ftp5.gwdg.de/pub/misc/cran/bin/linux/ubuntu xenial/'
sudo apt-get update
sudo apt-get upgrade
```

#### Installing RStudio

It is highly recommended to install [RStudio](https://www.rstudio.com/products/rstudio/download/#download), a powerful IDE for R. Output of polmineR methods is generally optimized to be displayed using RStudio facilities. If you are working on a remote server, running RStudio Server may be an interesting option to consider.

#### Base Installation of polmineR

The Corpus Workbench will require the pcre, glib and pkg-config libraries. They can be installed as follows. In addition libxml2 is installed, a dependency of the R package xml2 that is used for manipulating html output.

```{sh,  eval = FALSE}
sudo apt-get install libglib2.0-dev libssl-dev libcurl4-openssl-dev
sudo apt-get install libxml2-dev
sudo apt-get install libprotobuf-dev
```

The system requirements will now be fulfilled. From R, install dependencies for rcqp/polmineR first, and then rcqp and polmineR.

```{r, eval = FALSE}
install.packages("RcppCWB")
install.packages("polmineR")
```

Use devtools to install the development version of polmineR from GitHub.

```{r, eval = FALSE}
install.packages("devtools")
devtools::install_github("PolMine/polmineR", ref = "dev")
```

Finally, check the installation.

```{r, eval = FALSE}
library(polmineR)
use("polmineR")
```


#### Annex I: Setting the CORPUS_REGISTRY environment variable

The environment variable "CORPUS_REGISTRY" can be set as follows in R:

```{r, eval = FALSE}
Sys.setenv(CORPUS_REGISTRY = "C:/PATH/TO/YOUR/REGISTRY")
```

To set the environment variable CORPUS_REGISTRY permanently, see the instructions R offer how to find the file '.Renviron' or '.Renviron.site' when calling the help for the startup process(`?Startup`).


#### Annex II: Setting the interface to the Corpus Workbench

The standard interface used by the polmineR package to extract information from CWB indexed corpora is the package 'RcppCWB'. The interface is defined in a class called 'CQI'. To check which interface is used:

```{r, eval = TRUE}
class(polmineR:::CQI)
```

If you see "CQI.perl" leading the character vector that is returned, something went wrong. Accessing the corpora using perl scripts incurs an incredible performence loss. Reset the interface as follows:

```{r, eval = FALSE}
unlockBinding(env = getNamespace("polmineR"), sym = "CQI")
assign("CQI", CQI.rcqp$new(), envir = getNamespace("polmineR"))
lockBinding(env = getNamespace("polmineR"), sym = "CQI")
```


An alternative interface is provided by the package 'rcqp', [available at GitHub][https://github.com/PolMine/polmineR.Rcpp] so far.  To install and use 'rcqp':

```{r, eval = FALSE}
install.packages("rcqp")
```

To switch to the interface offered by polmineR.Rcpp, proceed as follows:

```{r, eval = FALSE}
unlockBinding(env = getNamespace("polmineR"), sym = "CQI")
assign("CQI", CQI.Rcpp$new(), envir = getNamespace("polmineR"))
lockBinding(env = getNamespace("polmineR"), sym = "CQI")
```


#### Annex III: polmineR - Full installation

To have access to all package functions and to run all package tests, the installation of further system requirements and packages is required. The xlsx dependency requires that rJava is installed and configured for R. That is done on the shell:

```{sh, eval = FALSE}
sudo apt-get install openjdk-8-jre
sudo R CMD javareconf
```

To run package tests including (re-)building the manual and vignettes, a working installation of Latex is required, too. Be aware that this may be a time-consuming operation.

```{sh, eval = FALSE}
sudo apt-get install texlive-full texlive-xetex 
```

Now install the remaining packages from within R.

```{r, eval = FALSE}
devtools::install_github("PolMine/polmineR.Rcpp")
install.packages(pkgs = c("rJava", "xlsx", "tidytext"))
```


## Annex IV: CWB corpora and the CORPUS_REGISTRY environment variable

Indexed corpora can be stored in two different locations. The conventional way is to keep CWB corpora in a directory with two subdirectories, a 'registry' directory, and an 'indexed_corpora' directory. The files in the registry directory ('registry' in short) describe the main features of a corpus, and where it is stored. It is necessary to inform rcqp, the package used by polmineR to access corpora, about the registry directory. That is done using the CORPUS_REGISTRY environment variable. It needs be defined before loading rcqp and polmineR. Note that you need to set the environment to the 'registry' folder, not the files that are located in this directory.

The CORPUS_REGISTRY environment variable can be set manually from the R console:

```{r, eval = FALSE}
Sys.setenv(CORPUS_REGISTRY = "/PATH/TO/YOUR/REGISTRY/DIRECTORY")
```

To check whether and how the environment variable is set:

```{r, eval = FALSE}
Sys.getenv("CORPUS_REGISTRY")
```

You can set the environment variable permanently to avoid having to set it each time before you want to use polmineR. A good way is to inlude the following line in the file .Renviron in your home directory:

```{r, eval = FALSE}
CORPUS_REGISTRY="/PATH/TO/YOUR/REGISTRY/DIRECTORY"
```

There are a few other options to have environment variables set at every time you launch polmineR. To learn about these, use the help for the R startup procedure.

```{r, eval = FALSE}
?Startup 
```

